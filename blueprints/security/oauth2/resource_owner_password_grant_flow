## Resource owner password grant flow

Resource owner password credentials grant from OAuth 2.0 allows a trusted client to generate a new token to access Online API by supplying username and password to login to Online.

Abstract overview of this process is depicted in following diagram.

![resource owner grant](https://cloud.githubusercontent.com/assets/8504018/6216445/39e15b54-b602-11e4-93b9-08e7e2e62c43.png)

Resource owner password credentials grant is a simple one step process where the client supplies all information needed to login to Online while the server authenticates user credentials and issues a new access token in order to use the API.

## Get access token [/token]

>`Note`: Resource owner password credentials grant works only on a `POST`. In order for this to work, the client must supply the client id in the form of Basic authorization as highlighted in the sample above.

>`Note`: The request requires clientId to be passed using Basic Http authentication. The encoded value used above is Base64 encoding performed on `cbdcfa43-dd67-4c38-b418-83572a936fca:`. Note that the username is the valid client id but the password field is empty.

Following table details more information about each form parameter supplied in the body.

| Property | Type | Description |
| :-------------------- | :---------- | ------------------------------------------------------------ |
| username | string | `Required`. Username to authenticate. |
| password | string | `Required`. Password to authenticate. |
| grant_type | string | `Required`. This must be password |

Following table details more information about each field in the response.

| Property | Type | Description |
| :-------------------- | :---------- | ------------------------------------------------------------ |
| token_type | string | `Returned always`. Type of token returned. Online supports only `Bearer` token. |
| refresh_token | string | `Returned always`. Not supported by Online yet. Will be `null` till this is supported. |
| access_token | string | `Returned always`. Actual authorization token issued for the user by Online. |
| expires_in | string | `Returned always`. The lifetime of access_token issued. |

> `Note`: This endpoint supplies back cookies to persist authentication against the user. This is needed to maintain compatibility across the rest of the site.

## Possible errors

There are 2 broad categories in which this endpoint can fail. They are invalid inputs or invalid user profile state. Sample error messages are documented below for reference.

### Invalid inputs

This kind of error messages will occur if any input formats supplied is not valid. A sample message is listed below for your reference.

+ Request (application/x-www-form-urlencoded)

    + Headers

            Authorization: Basic Y2JkY2ZhNDMtZGQ2Ny00YzM4LWI0MTgtODM1NzJhOTM2ZmNhOg==
            cid: 05e230bf-a9cf-4b31-bc54-d3a995f62526

    + Body

            username=services06@bgdigitaltest.co.uk&password=password12&grant_type=password

+ Response 400 (application/json)

          {
              "error": "invalid_request",
              "error_description": "error.client.userProfile.password.empty"
          }

Possible `error_description` that can be expected are listed below.

| Error description  | Significance |
| :-------------------- | :---------- |
| error.client.userProfile.notFound   | Unable to find the user registered online. |
| error.client.userProfile.login.triesLeft.1 | Password validation failed. There is just one more attempt before the profile will be locked |
| error.client.userProfile.login.triesLeft.2 | Password validation failed. There is just 2 more attempts before the profile will be locked |
| error.client.userProfile.login.denied | Password validation failed for WTP user. |
| error.client.userProfile.invalid.britishgas  | User does not have valid profile in BG but instead has one in SE. |
| error.client.userProfile.invalid.sainsbury   | User does not have valid profile in SE but instead has one in BG. |


### Invalid user profile state

This kind of error message will occur if inputs provided are valid and yet for some business reason, we cannot allow the user to continue.

+ Request (application/x-www-form-urlencoded)

    + Headers

            Authorization: Basic Y2JkY2ZhNDMtZGQ2Ny00YzM4LWI0MTgtODM1NzJhOTM2ZmNhOg==
            cid: 05e230bf-a9cf-4b31-bc54-d3a995f62526

    + Body

            username=services06@bgdigitaltest.co.uk&password=password12&grant_type=password

+ Response 403 (application/json)

          {
              "error": "server_error",
              "error_description": "error.server.userProfile.locked"
          }

Possible error messages that can be expected and their significance is listed below.

| Error description  | Significance |
| :-------------------- | :---------- |
| error.server.userProfile.noAssociatedAccounts  | Unable to find a valid account listed in SAP for this user. |
| error.server.userProfile.locked.inactivity  | Locked account due to inactivity. |
| error.server.userProfile.frozen   | User account is now locked. Recovered by calling helpline. |
| error.server.userProfile.locked   | User account is now locked. Recoverable through password reset. |
| error.server.userProfile.notValidatedYet  | The email is yet to be validated. |
| error.server.thinUserProfile.locked   | WTP profile locked. |
| error.server.userProfile.inactive   |  Inactive account for more than 6 months. |
| error.server.userProfile.locked.address  |  Locked account. |

### Access token [POST]
+ Request (application/x-www-form-urlencoded)

    + Headers

            Authorization: Basic Y2JkY2ZhNDMtZGQ2Ny00YzM4LWI0MTgtODM1NzJhOTM2ZmNhOg==
            cid: 05e230bf-a9cf-4b31-bc54-d3a995f62526

    + Body

            username=services06@bgdigitaltest.co.uk&password=password12&grant_type=password

+ Response 200 (application/json)

            {
                "expires_in": 3599,
                "token_type": "Bearer",
                "refresh_token": null,
                "access_token": "2fd05283-3a5e-5e99-a0be-ef7b41d218fe"
            }
